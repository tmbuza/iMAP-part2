<!-- # (PART) METAGENOMIC PROFILING {-} -->

# Taxonomic Profiling Using MetaPhlAn Pipeline {#metaphlan-pipeline}
- We loop through the fastq files using the following parameters.
- You can optionally customize these parameters to suit your needs.
- Note that most parameters are default setting except the *-t rel_ab_w_read_stats* which will add the read count to the output.

```bash
for i in data/*.fastq.gz
	do 
		metaphlan $i \
		--input_type fastq \
		--force \
		--bowtie2db /Volumes/SeagateTMB/metaphlan_databases/ \
		--nproc 4 \
		--stat_q 0.02 \
		--min_mapq_val 5 \
		--output_file ${i%}_metaphlan3_profile.txt \
		--bowtie2out ${i%}_metaphlan3_bowtie2out.txt \
		--biom ${i%}_metaphlan3_abundance.biom \
    -t rel_ab_w_read_stats
	done
	
# Merging the profiles tables and store in the folder named metaphlan3_profiles
mkdir -p metaphlan3_profiles
merge_metaphlan_tables.py metaphlan3_profiles/*_metaphlan3_profile*.txt > metaphlan3_profiles/merged_abundance_table.txt

```

## Merging abundance files
- First we create an empty column to hold the file names.
- Then we loop through each file to fill the actual file names.
- Then we create the m3_merged_abund_table.rds containing sample ID, taxonomy and the abundances.

> Note: We will specify the path where the `metaphlan` output is located. Replace the path to match yours.

```{r withcounts}
source("R/common.R")

set.seed(110912)

path <- "/Volumes/RedSeagate/SYNTHETIC/microbes/data/*_profile.txt"
files <- Sys.glob(path)

merged_files <- data.frame(ModelName = character(), Object = character(), stringsAsFactors = FALSE) %>%
  mutate(Filename = "")

for (i in 1:length(files)){
    currentFile = read_delim(files[i], skip = 4, show_col_types = FALSE) %>% mutate(Filename = files[i])
    merged_files = rbind(merged_files, currentFile)
}

m3_merged_abund_table <- merged_files %>% 
  rename_all(tolower) %>%
  rename(clade_name = colnames(merged_files)[1],
         sample_id = filename,
         rel_abund = relative_abundance, 
         mapped_read = estimated_number_of_reads_from_the_clade) %>% 
  mutate(sample_id = str_replace_all(sample_id, ".*/", ""),
         sample_id = str_replace_all(sample_id, ".fast.*", "")) %>%
  select(sample_id, taxonomy = clade_name, rel_abund, mapped_read)
    
head(m3_merged_abund_table) %>% as.data.frame()

saveRDS(m3_merged_abund_table, "RDataRDS/m3_merged_abund_table.rds")
```

## Abundance distribution at taxon-level

```{r m3_taxon_bars, fig.height=6, fig.width=6}
library(ggplot2)
m3_merged_abund_table <- readRDS("RDataRDS/m3_merged_abund_table.rds")

m3_merged_abund_table %>% 
  select(sample_id, taxonomy, rel_abund) %>% 
  distinct() %>% 
  dplyr::filter(!grepl("\\|p__*", taxonomy)) %>%
  group_by(sample_id, taxonomy, rel_abund) %>%
  summarise(count = sum(rel_abund),
            rel_abund = rel_abund/100, .groups = "drop") %>% 
  select(-count) %>% 
  mutate(taxonomy = str_replace_all(taxonomy, ".*__", "")) %>% 
  ggplot(aes(x = sample_id, y = rel_abund, fill = taxonomy)) +
  geom_col() +
  theme_bw() +
  labs(x = "", y = "Relative Abundance", title = "", fill = "Kingdom") +
  noxlabels +
  scale_y_continuous(expand = c(0, 0))

m3_merged_abund_table %>% 
  select(sample_id, taxonomy, rel_abund) %>% 
  distinct() %>% 
  dplyr::filter(!grepl("\\|c__*", taxonomy),
                grepl("p__*", taxonomy)) %>%
  mutate(taxonomy = str_replace_all(taxonomy, ".*__", "")) %>% 
  group_by(sample_id, taxonomy, rel_abund) %>%
  summarise(count = sum(rel_abund),
            rel_abund = rel_abund/100, .groups = "drop") %>% 
  select(-count) %>% 
  ggplot(aes(x = sample_id, y = rel_abund, fill = taxonomy)) +
  geom_col(position = "fill") +
  theme_bw() +
  labs(x = "", y = "Relative Abundance", title = "", fill = "Phylum") +
  noxlabels +
  scale_y_continuous(expand = c(0, 0))
```

```{r eval=FALSE, include=FALSE}
m3_merged_abund_table %>% 
  select(sample_id, taxonomy, rel_abund) %>% 
  distinct() %>% 
  dplyr::filter(!grepl("\\|o__*", taxonomy),
                grepl("c__*", taxonomy)) %>%
  mutate(taxonomy = str_replace_all(taxonomy, ".*__", "")) %>% 
  group_by(sample_id, taxonomy, rel_abund) %>%
  summarise(count = sum(rel_abund),
            rel_abund = rel_abund/100, .groups = "drop") %>% 
  select(-count) %>% 
  ggplot(aes(x = sample_id, y = rel_abund, fill = taxonomy)) +
  geom_col(position = "fill") +
  theme_bw() +
  labs(x = "", y = "Relative Abundance", title = "", fill = "Class") +
  noxlabels +
  scale_y_continuous(expand = c(0, 0))

m3_merged_abund_table %>% 
  select(sample_id, taxonomy, rel_abund) %>% 
  distinct() %>% 
  dplyr::filter(!grepl("\\|f__*", taxonomy),
                grepl("o__*", taxonomy)) %>%
  mutate(taxonomy = str_replace_all(taxonomy, ".*__", "")) %>% 
  group_by(sample_id, taxonomy, rel_abund) %>%
  summarise(count = sum(rel_abund),
            rel_abund = rel_abund/100, .groups = "drop") %>% 
  select(-count) %>% 
  ggplot(aes(x = sample_id, y = rel_abund, fill = taxonomy)) +
  geom_col(position = "fill") +
  theme_bw() +
  labs(x = "", y = "Relative Abundance", title = "", fill = "Order") +
  noxlabels +
  scale_y_continuous(expand = c(0, 0))

m3_merged_abund_table %>% 
  select(sample_id, taxonomy, rel_abund) %>% 
  distinct() %>% 
  dplyr::filter(!grepl("\\|g__*", taxonomy),
                grepl("f__*", taxonomy)) %>%
  mutate(taxonomy = str_replace_all(taxonomy, ".*__", "")) %>% 
  group_by(sample_id, taxonomy, rel_abund) %>%
  summarise(count = sum(rel_abund),
            rel_abund = rel_abund/100, .groups = "drop") %>% 
  select(-count) %>% 
  ggplot(aes(x = sample_id, y = rel_abund, fill = taxonomy)) +
  geom_col(position = "fill") +
  theme_bw() +
  labs(x = "", y = "Relative Abundance", title = "", fill = "Family") +
  noxlabels +
  scale_y_continuous(expand = c(0, 0))

m3_merged_abund_table %>% 
  select(sample_id, taxonomy, rel_abund) %>% 
  distinct() %>% 
  dplyr::filter(!grepl("\\|s__*", taxonomy),
                grepl("g__*", taxonomy)) %>%
  mutate(taxonomy = str_replace_all(taxonomy, ".*__", "")) %>% 
  group_by(sample_id, taxonomy, rel_abund) %>%
  summarise(count = sum(rel_abund),
            rel_abund = rel_abund/100, .groups = "drop") %>% 
  select(-count) %>% 
  ggplot(aes(x = sample_id, y = rel_abund, fill = taxonomy)) +
  geom_col(position = "fill") +
  theme_bw() +
  labs(x = "", y = "Relative Abundance", title = "", fill = "Genus") +
  noxlabels +
  scale_y_continuous(expand = c(0, 0))

m3_merged_abund_table %>% 
  select(sample_id, taxonomy, rel_abund) %>% 
  distinct() %>% 
  dplyr::filter(grepl("s__*", taxonomy)) %>%
  mutate(taxonomy = str_replace_all(taxonomy, ".*__", "")) %>% 
  group_by(sample_id, taxonomy, rel_abund) %>%
  summarise(count = sum(rel_abund),
            rel_abund = rel_abund/100, .groups = "drop") %>% 
  select(-count) %>% 
  ggplot(aes(x = sample_id, y = rel_abund, fill = taxonomy)) +
  geom_col(position = "fill") +
  theme_bw() +
  labs(x = "", y = "Relative Abundance", title = "", fill = "Species") +
  noxlabels +
  scale_y_continuous(expand = c(0, 0))
```


## Getting abundance at taxon-level
- Here we demonstrate how to use the `filter` function from `dplyr` to extract abundance at genus taxonomic-lineage.
- Additional processing is also done to create a tidy dataframe.

```{r}
taxlevels <- c("kingdom", "phylum", "class", "order", "family", "genus")
m3_taxa_abund <- readRDS("RDataRDS/m3_merged_abund_table.rds") %>% 
  select(sample_id, taxonomy, rel_abund) %>% 
  distinct() %>% 
  dplyr::filter(!grepl("\\|s__*", taxonomy),
                grepl("g__*", taxonomy)) %>%
  group_by(sample_id, taxonomy, rel_abund) %>%
  summarise(count = sum(rel_abund),
            rel_abund = rel_abund/100, .groups = "drop") %>% 
  select(-count) %>% 
  pivot_wider(id_cols = "taxonomy", names_from = "sample_id", values_from = "rel_abund") %>% 
  mutate(otu = paste("otu", seq(1:length(rownames(.))), sep = ""), .before = 1) %>% 
  mutate_if(is.numeric, ~replace(., is.na(.), 0 )) %>% 
  separate(taxonomy, into = all_of(taxlevels), sep = "\\|")
  
tail(m3_taxa_abund) %>% as.data.frame()
```


## Creating MetaPhlAn otutable and taxonomy objects
```{r}
m3_otutable <- readRDS("RDataRDS/m3_taxa_abund.rds") %>% 
  select(-all_of(taxlevels))

saveRDS(m3_otutable, "RDataRDS/m3_otutable.rds")
head(m3_otutable)[, 1:5] %>% as.data.frame()

m3_taxonomy <- readRDS("RDataRDS/m3_taxa_abund.rds") %>% 
  select(otu, all_of(taxlevels))

saveRDS(m3_taxonomy, "RDataRDS/m3_taxonomy.rds")
head(m3_taxonomy)[, 1:5] %>% as.data.frame()
```

## Creating Embedded metadata (optional)
```{r}

```

